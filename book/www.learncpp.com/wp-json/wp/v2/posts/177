{"id":177,"date":"2008-01-28T08:39:08","date_gmt":"2008-01-28T16:39:08","guid":{"rendered":"http:\/\/www.learncpp.com\/cpp-tutorial\/118-virtual-base-classes\/"},"modified":"2023-09-11T11:05:41","modified_gmt":"2023-09-11T18:05:41","slug":"virtual-base-classes","status":"publish","type":"post","link":"https:\/\/www.learncpp.com\/cpp-tutorial\/virtual-base-classes\/","title":{"rendered":"25.8 &#8212; Virtual base classes"},"content":{"rendered":"<p>Last chapter, in lesson <a href=\"https:\/\/www.learncpp.com\/cpp-tutorial\/multiple-inheritance\/\">24.9 -- Multiple inheritance<\/a>, we left off talking about the &#8220;diamond problem&#8221;.  In this section, we will resume this discussion.<\/p>\n<p>Note: This section is an advanced topic and can be skipped or skimmed if desired.<\/p>\n<p><strong>The diamond problem<\/strong><\/p>\n<p>Here is our example from the previous lesson (with some constructors) illustrating the diamond problem:<\/p>\n<pre class=\"language-cpp line-numbers\"><code class=\"language-cpp match-braces\">#include &lt;iostream&gt;\r\n\r\nclass PoweredDevice\r\n{\r\npublic:\r\n    PoweredDevice(int power)\r\n    {\r\n\t\tstd::cout &lt;&lt; \"PoweredDevice: \" &lt;&lt; power &lt;&lt; '\\n';\r\n    }\r\n};\r\n\r\nclass Scanner: public PoweredDevice\r\n{\r\npublic:\r\n    Scanner(int scanner, int power)\r\n        : PoweredDevice{ power }\r\n    {\r\n\t\tstd::cout &lt;&lt; \"Scanner: \" &lt;&lt; scanner &lt;&lt; '\\n';\r\n    }\r\n};\r\n\r\nclass Printer: public PoweredDevice\r\n{\r\npublic:\r\n    Printer(int printer, int power)\r\n        : PoweredDevice{ power }\r\n    {\r\n\t\tstd::cout &lt;&lt; \"Printer: \" &lt;&lt; printer &lt;&lt; '\\n';\r\n    }\r\n};\r\n\r\nclass Copier: public Scanner, public Printer\r\n{\r\npublic:\r\n    Copier(int scanner, int printer, int power)\r\n        : Scanner{ scanner, power }, Printer{ printer, power }\r\n    {\r\n    }\r\n};<\/code><\/pre>\n<p>Although you might expect to get an inheritance diagram that looks like this:<\/p>\n<p><img src=\"http:\/\/www.learncpp.com\/images\/CppTutorial\/Section11\/PoweredDevice.gif\"><\/p>\n<p>If you were to create a Copier class object, by default you would end up with two copies of the PoweredDevice class -- one from Printer, and one from Scanner.  This has the following structure:<\/p>\n<p><img src=\"http:\/\/www.learncpp.com\/images\/CppTutorial\/Section11\/PoweredDevice2.gif\"><\/p>\n<p>We can create a short example that will show this in action:<\/p>\n<pre class=\"language-cpp line-numbers\"><code class=\"language-cpp match-braces\">int main()\r\n{\r\n    Copier copier{ 1, 2, 3 };\r\n\r\n    return 0;\r\n}<\/code><\/pre>\n<p>This produces the result:<\/p>\n<pre>\r\nPoweredDevice: 3\r\nScanner: 1\r\nPoweredDevice: 3\r\nPrinter: 2\r\n<\/pre>\n<p>As you can see, PoweredDevice got constructed twice.<\/p>\n<p>While this is often desired, other times you may want only one copy of PoweredDevice to be shared by both Scanner and Printer.  <\/p>\n<p><strong>Virtual base classes<\/strong><\/p>\n<p>To share a base class, simply insert the &#8220;virtual&#8221; keyword in the inheritance list of the derived class.  This creates what is called a <strong>virtual base class<\/strong>, which means there is only one base object.  The base object is shared between all objects in the inheritance tree and it is only constructed once. Here is an example (without constructors for simplicity) showing how to use the virtual keyword to create a shared base class:<\/p>\n<pre class=\"language-cpp line-numbers\"><code class=\"language-cpp match-braces\">class PoweredDevice\r\n{\r\n};\r\n\r\nclass Scanner: virtual public PoweredDevice\r\n{\r\n};\r\n\r\nclass Printer: virtual public PoweredDevice\r\n{\r\n};\r\n\r\nclass Copier: public Scanner, public Printer\r\n{\r\n};<\/code><\/pre>\n<p>Now, when you create a Copier class object, you will get only one copy of PoweredDevice per Copier that will be shared by both Scanner and Printer.<\/p>\n<p>However, this leads to one more problem: if Scanner and Printer share a PoweredDevice base class, who is responsible for creating it?  The answer, as it turns out, is Copier.  The Copier constructor is responsible for creating PoweredDevice.  Consequently, this is one time when Copier is allowed to call a non-immediate-parent constructor directly:<\/p>\n<pre class=\"language-cpp line-numbers\"><code class=\"language-cpp match-braces\">#include &lt;iostream&gt;\r\n\r\nclass PoweredDevice\r\n{\r\npublic:\r\n    PoweredDevice(int power)\r\n    {\r\n\t\tstd::cout &lt;&lt; \"PoweredDevice: \" &lt;&lt; power &lt;&lt; '\\n';\r\n    }\r\n};\r\n\r\nclass Scanner: virtual public PoweredDevice \/\/ note: PoweredDevice is now a virtual base class\r\n{\r\npublic:\r\n    Scanner(int scanner, int power)\r\n        : PoweredDevice{ power } \/\/ this line is required to create Scanner objects, but ignored in this case\r\n    {\r\n\t\tstd::cout &lt;&lt; \"Scanner: \" &lt;&lt; scanner &lt;&lt; '\\n';\r\n    }\r\n};\r\n\r\nclass Printer: virtual public PoweredDevice \/\/ note: PoweredDevice is now a virtual base class\r\n{\r\npublic:\r\n    Printer(int printer, int power)\r\n        : PoweredDevice{ power } \/\/ this line is required to create Printer objects, but ignored in this case\r\n    {\r\n\t\tstd::cout &lt;&lt; \"Printer: \" &lt;&lt; printer &lt;&lt; '\\n';\r\n    }\r\n};\r\n\r\nclass Copier: public Scanner, public Printer\r\n{\r\npublic:\r\n    Copier(int scanner, int printer, int power)\r\n        : PoweredDevice{ power }, \/\/ PoweredDevice is constructed here\r\n        Scanner{ scanner, power }, Printer{ printer, power }\r\n    {\r\n    }\r\n};<\/code><\/pre>\n<p>This time, our previous example:<\/p>\n<pre class=\"language-cpp line-numbers\"><code class=\"language-cpp match-braces\">int main()\r\n{\r\n    Copier copier{ 1, 2, 3 };\r\n\r\n    return 0;\r\n}<\/code><\/pre>\n<p>produces the result:<\/p>\n<pre>\r\nPoweredDevice: 3\r\nScanner: 1\r\nPrinter: 2\r\n<\/pre>\n<p>As you can see, PoweredDevice only gets constructed once.<\/p>\n<p>There are a few details that we would be remiss if we did not mention.<\/p>\n<p>First, for the constructor of the most derived class, virtual base classes are always created before non-virtual base classes, which ensures all bases get created before their derived classes.<\/p>\n<p>Second, note that the Scanner and Printer constructors still have calls to the PoweredDevice constructor.  When creating an instance of Copier, these constructor calls are simply ignored because Copier is responsible for creating the PoweredDevice, not Scanner or Printer.  However, if we were to create an instance of Scanner or Printer, those constructor calls would be used, and normal inheritance rules apply.<\/p>\n<p>Third, if a class inherits one or more classes that have virtual parents, the <em>most<\/em> derived class is responsible for constructing the virtual base class.  In this case, Copier inherits Printer and Scanner, both of which have a PoweredDevice virtual base class.  Copier, the most derived class, is responsible for creation of PoweredDevice.  Note that this is true even in a single inheritance case: if Copier singly inherited from Printer, and Printer was virtually inherited from PoweredDevice, Copier is still responsible for creating PoweredDevice.<\/p>\n<p>Fourth, all classes inheriting a virtual base class will have a virtual table, even if they would normally not have one otherwise, and thus instances of the class will be larger by a pointer.<\/p>\n<p>Because Scanner and Printer derive virtually from PoweredDevice, Copier will only be one PoweredDevice subobject.  Scanner and Printer both need to know how to find that single PoweredDevice subobject, so they can access its members (because after all, they are derived from it).  This is typically done through some virtual table magic (which essentially stores the offset from each subclass to the PoweredDevice subobject).<\/p>\n<div class=\"prevnext\"><div class=\"prevnext-inline\">\n\t<a class=\"nav-link\" href=\"https:\/\/www.learncpp.com\/cpp-tutorial\/object-slicing\/\">\n <div class=\"nav-button nav-button-next\">\n    <div class=\"nav-button-icon\"><i class=\"fa fa-chevron-circle-right\" aria-hidden=\"true\"><\/i><\/div>\n    <div class=\"nav-button-text\">\n      <div class=\"nav-button-title\">Next lesson<\/div>\n      <div class=\"nav-button-lesson\">\n        <span class=\"nav-button-lesson-number\">25.9<\/span>Object slicing\n      <\/div>\n    <\/div>\n  <\/div><\/a>\n  \t<a class=\"nav-link\" href=\"\/\">\n  <div class=\"nav-button nav-button-index\">\n    <div class=\"nav-button-icon\"><i class=\"fa fa-home\" aria-hidden=\"true\"><\/i><\/div>\n    <div class=\"nav-button-text\">\n      <div class=\"nav-button-title\">Back to table of contents<\/div>\n    <\/div>\n<\/div><\/a>\n  \t<a class=\"nav-link\" href=\"https:\/\/www.learncpp.com\/cpp-tutorial\/pure-virtual-functions-abstract-base-classes-and-interface-classes\/\">\n  <div class=\"nav-button nav-button-prev\">\n    <div class=\"nav-button-icon\"><i class=\"fa fa-chevron-circle-left\" aria-hidden=\"true\"><\/i><\/div>\n    <div class=\"nav-button-text\">\n      <div class=\"nav-button-title\">Previous lesson<\/div>\n      <div class=\"nav-button-lesson\">\n        <span class=\"nav-button-lesson-number\">25.7<\/span>Pure virtual functions, abstract base classes, and interface classes\n      <\/div>\n    <\/div>\n  <\/div><\/a>\n  <\/div><\/div>\n","protected":false},"excerpt":{"rendered":"<p>Last chapter, in lesson , we left off talking about the &#8220;diamond problem&#8221;. In this section, we will resume this discussion. Note: This section is an advanced topic and can be skipped or skimmed if desired. The diamond problem Here is our example from the previous lesson (with some constructors) &hellip;<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":[],"categories":[3],"tags":[],"_links":{"self":[{"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/posts\/177"}],"collection":[{"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/comments?post=177"}],"version-history":[{"count":20,"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/posts\/177\/revisions"}],"predecessor-version":[{"id":15261,"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/posts\/177\/revisions\/15261"}],"wp:attachment":[{"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/media?parent=177"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/categories?post=177"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.learncpp.com\/wp-json\/wp\/v2\/tags?post=177"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}